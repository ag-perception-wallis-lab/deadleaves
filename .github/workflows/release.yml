name: Publish Python üêç distribution üì¶ to PyPI and TestPyPI

on:
    # Automatically run on releases
    release:
        types: [released]
    # Allow manual trigger
    workflow_dispatch:

jobs:
    build:
        name: Build distribution üì¶
        runs-on: ubuntu-latest

        steps:
            - name: Fetch wheel(s) from release
              uses: dsaltares/fetch-gh-release-asset@1.1.0
              with:
                regex: true
                file: 'deadleaves-.[0-9]*\.[0-9]*\.[0-9]*\.whl'
                target: 'dist\'
            
            - name: Fetch sdist(s) from release
              uses: dsaltares/fetch-gh-release-asset@1.1.0
              with:
                regex: true
                file: 'deadleaves-.[0-9]*\.[0-9]*\.[0-9]*\.tar.gz'
                target: 'dist\'

    test_publish:
        name: Publish to TestPyPI
        needs: build
        runs-on: ubuntu-latest

        permissions:
            id-token: write

        steps:
        - name: Download all the dists
          uses: pypa/gh-action-pypi-publish@release/v1
          with: 
            repository-url: https://test.pypi.org/legacy/
            
        - name: Test install from TestPyPI
          run: |
            pip install \
            --index-url https://test.pypi.org/simple/ \
            --extra-intex-url https://pypi.org/simple \
            deadleaves